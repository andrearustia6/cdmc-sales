@{
    ViewBag.Title = "Index";
}
@using Entity
@using Model
@model AjaxCrmTypedList


@(Html.Telerik().Splitter().Name("sp1").HtmlAttributes(new { style = "min-height: 800px;" })
              .Orientation(SplitterOrientation.Horizontal).Panes(panes =>
              {
                  panes.Add().Size("30%").Content(@<text>@GetCRMS()</text>);
                  panes.Add().Content(@<text>@GetCompanyDetails()</text>);
              }))
@helper GetCRMS()
{
    
<div>
<button id="group-open-button" >分组管理</button>
@(Html.Telerik().Window()
        .Name("groupWindow")
        .Title("分组")
        .Content(@<text>
          @Html.Partial("groupwindow", new UserFavorsCrmGroup())
            </text>)
        .Width(400)
        .Draggable(true)
        .Modal(true)
        .Visible(false)
)
@(Html.Telerik().Window()
        .Name("groupListWindow")
        .Title("分组")
        .Content(@<text>
          @Html.Partial("grouplistwindow", Model.CustomCrmGroups)
            </text>).Width(600).ClientEvents(e => e.OnClose("onGroupListWindowSubmit"))
        .Draggable(true)
        .Modal(true)
        .Visible(false)
)

<div id="mainnavigationcontainer">

@Html.Partial("mainnavigationcontainer",Model)
</div>
</div>
 
}
@helper GetCompanyDetails()
{
    <div id="crmdetailscontainer">
    @if (Model.AllCRMs.FirstOrDefault() != null)
    {
       @Html.Partial("salesexitem",Model.AllCRMs.FirstOrDefault())
    }
    </div>
}
<ul id="groupcontextmenu" class="jeegoocontext cm_default">
  <li id="groupmanagement"> <span class=""></span><p class= "regrouptext">分组管理</p> </li>
</ul>

 <ul id="favorscontextmenu" class="jeegoocontext cm_default">
        <li class="regroup">
            <span class=""></span>
            <p class= "regrouptext">移动可打公司至</p>
            <ul>
            </ul>
        </li>
         <li class="separator"></li>
        <li class="remove" id="remove">
            <span class=""></span>
            从组中移出
        </li>
        <li class="separator"></li>
        <li class="blowed">
            <span class=""></span>
            Blowed，放回公海
        </li>
    </ul>   
 <ul id="contextmenu" class="jeegoocontext cm_default">
        <li class="regroup">
            <span class=""></span>
            <p class= "regrouptext">移动可打公司至</p>
            <ul>
            </ul>
        </li>
        <li class="separator"></li>
        <li class="blowed">
            <span class="icon drive"></span>
            Blowed，放回公海
        </li>
    </ul>    

<script type="text/javascript">

    $(document).ready(function () {
        initial();
    });

    function initial() {

        //分组字体标注
        $('#customView').find('>ul >li >div >span').css("fontSize", "23px");
        $('#customView').find('>ul >li >ul >li >div >span').css("fontSize", "15px");
        $('#navigationView').find('>ul >li >div >span').css("fontSize", "15px");
        
        //lead状态颜色标注
         $('#mainnavigationcontainer span').each(function(){
          var $this = $(this);
          var spantext = $this.text();
          if(spantext.indexOf(',&6*')>0)//Call-Backed
          {
              $this.css('color', '#95CACA');
             spantext = spantext.replace(",&6*","");
          }
          else if(spantext.indexOf(',&2*')>0)//blowed
          {
              $this.css('color', '#E0E0E0');
             spantext = spantext.replace(",&2*","");
          }
          else if(spantext.indexOf(',&0*')>0)//no call
          {
            $this.css('color','red');
            spantext = spantext.replace(",&0*","");
          }
          else if(spantext.indexOf(',&9*')>0)//close
          {
              $this.css('color', '#CEFFCE');
          spantext = spantext.replace(",&9*","");
          }
          else if(spantext.indexOf(',&7*')>0)//Waiting for Approval
          {
              $this.css('color', '#D3A4FF');
          spantext = spantext.replace(",&7*","");
          }
          else if(spantext.indexOf(',&8*')>0)//Qualified Decision
          {
              $this.css('color', 'yellow');
            spantext = spantext.replace(",&8*","");
          }
          $this.text(spantext);
         });
        
        //生成关联菜单子菜单
        var ul = $(".regroup ul");
        ul.children().remove();
        var customli = $('#customView >ul >li');
        customli.each(function () {
            var t = $(this).find('>div >span').text();
            var v = $(this).find('>div >input').val();
            ul.append('<li class="grouptarget">' + t + '<input type="hidden" value=' + v + '></li>');
        });

        //添加分组
        $('#group-open-button')
                .click(function (e) {
                    e.preventDefault();
                    gw().center().open();
                });


        $('#navigationView').find('>ul >li').jeegoocontext('contextmenu', {
            widthOverflowOffset: 0,
            heightOverflowOffset: 3,
            submenuLeftOffset: -4,
            submenuTopOffset: -5,
            onSelect: contextMenuSelected,
            onShow: generateContextMenu
        });

        $('#customView').find('>ul >li').jeegoocontext('groupcontextmenu', {
            widthOverflowOffset: 0,
            heightOverflowOffset: 3,
            submenuLeftOffset: -4,
            submenuTopOffset: -5,
            onSelect: groupContextMenuSelected
        });
        
        $('#customView').find('>ul >li >ul >li').jeegoocontext('favorscontextmenu', {
            widthOverflowOffset: 0,
            heightOverflowOffset: 3,
            submenuLeftOffset: -4,
            submenuTopOffset: -5,
            onSelect: contextMenuSelected,
            onShow: generateContextMenu
        });
    }

    //生成动态子菜单
    function generateContextMenu(e, context) {
        //更新context菜单公司名
        var crmtext = $(context).find('>div >span.t-in').text();
        crmtext = crmtext.split(',')[0];
        $(' .regrouptext').text("移动" + crmtext + "到");
      
    }

    //分组管理
    function groupContextMenuSelected(e, context) {
       var groupid = $(context).find('input').val();
       var targetid = $(e.currentTarget).attr('id');
       if(targetid=='groupmanagement')
       {
            e.preventDefault();
            gw().center().open();
       }
     
      
    }

    //公司关联菜单选中/自定义组公司关联选中
    function contextMenuSelected(e, context) {
        var $target = $(e.target);

        //copy到新分组
        if ($target.hasClass('grouptarget')) {
            var crmid = $(context).find('>div >input').val();
            var groupid = $(e.currentTarget).find('input').val();

            $.post('_CopyCrmToGroup', { crmid: crmid, groupid: groupid }, function (result) {
                $('#crmdfavorsscontainer').html(result);
                initial();
            });
        }

        //释放回公司池
        if ($target.hasClass('blowed')) {
            var crmid = $(context).find('>div >input').val();
            $.post('_CrmBlowed', { crmid: crmid }, function (result) {
                $('#mainnavigationcontainer').html(result);
                initial();
            });
        }


        //释放回公司池
        if ($target.hasClass('remove')) {
            var crmid = $(context).find('>div >input').val();
            var groupid = $(e.currentTarget).find('input').val();
            $.post('_CrmRemove', { crmid: crmid }, function (result) {
                $('#crmdfavorsscontainer').html(result);
                initial();
            });
        }
     }

    //获取主树
    function nv() {
        return $('#navigationView').data('tTreeView');
    }

    //获取分组窗口
    function gw() {
        return $('#groupListWindow').data('tWindow');
    }
   //提交分组更改
   function onGroupListWindowSubmit(e)
   {
       $.post('_RefreshCrmList', null, function (result) {
                $('#mainnavigationcontainer').html(result);
                initial();
            });
   }
    //公司选择 
    function onIndexSelect(e) {
      
        var indexs = nv().getItemValue(e.item);
        if (indexs.indexOf("分组") < 0 ) {
            $.post('_SelectedList', { indexs: indexs }, function (result) {
                $('#crmdetailscontainer').html(result);
            });
        }
    }

    //展开所有leads
    function expandRow(grid, row) {
            grid.expandRow(row);
    }

    function onRowDataBound(e) {
        var grid = $(this).data('tGrid');
        expandRow(grid, e.row);
    }



</script>


<style>
    .fieldblock
    {
    
    }
    .fieldname div
    {
        padding: 2px;
        min-width: 100px;
        background-color: #FFDEAD;
        border-bottom-color: #FF8C00;
        border: 1px solid #CCC;
        display: inline-block;
      
      
        margin-left: 8px;
        margin-bottom: 8px;
    }
    .fieldname div font
    {
        font-size: 12px;
        color: Green;
    }
</style>


