@using Entity
@using Sales.Model
@model _AvaliableCompanies


<div class="memberCompanies" >

@{
    if(Model.MemberCompanies!=null)
    {
    <span>在打公司</span>
        @(Html.Telerik().TreeView().Name("memberCompanies")
        .HtmlAttributes(new { style = "" })
        .ClientEvents(e => e.OnSelect("onIndexSelect"))
        .ClientEvents(e => e.OnLoad("OnmemberLoad"))
        .BindTo(Model.MemberCompanies, mappings =>
        {
            mappings.For<_CoreLVL>(binding => binding
            .ItemDataBound((item, core) =>
            {
                item.Text = core.CoreNameDisplayText;
                item.Value = core.ID.ToString();
                
            })
            .Children(core => core.DispMaturitys));

            mappings.For<_Maturity>(binding => binding
            .ItemDataBound((item, maturity) =>
            {
                item.Text = maturity.DisplayName;
                item.Value = maturity.ID.ToString();
            })
            .Children(maturity => maturity._CRMs));

            mappings.For<_CRM>(binding => binding
          .ItemDataBound((item, crm) =>
          {
              item.Text = crm.DisplayName;
              item.Value = crm.ID.ToString();
              if (Utl.Employee.CurrentRole.Level == ManagerRequired.LVL)
              {
                  if (crm.CrmCommentStateID == null)
                      item.ImageUrl = "";
                  else if (crm.CrmCommentStateID == 1)
                      item.ImageUrl = "../images/gantaihao.jpg";
                  else if (crm.CrmCommentStateID == 2)
                      item.ImageUrl = "../images/wenhao-2.jpg";
                  else if (crm.CrmCommentStateID == 3)
                      item.ImageUrl = "../images/wenhao-2.jpg";
                  else if (crm.CrmCommentStateID == 4)
                      item.ImageUrl = "";
              }
              else
              {
                  if (crm._Comments.OrderByDescending(dd => dd.CommentDate).FirstOrDefault()==null)
                      item.ImageUrl = "";
                  else if (crm._Comments.OrderByDescending(dd => dd.CommentDate).FirstOrDefault().Submitter == Utl.Employee.CurrentUserName)
                      item.ImageUrl = "../images/gantaihao.jpg";
                  else
                      item.ImageUrl = "../images/wenhao-2.jpg";
              }
          }));
        })

) 
    }
}
    
</div>

<div class="publicCompanies">
@{
    if (Model.MemberCompanies != null)
    { 
        <span>公海公司</span>
        @(Html.Telerik().TreeView().Name("publicCompanies").HtmlAttributes(new { style = "" })
                        .ClientEvents(e => e.OnSelect("onIndexSelectPublic"))
                .BindTo(Model.PublicCompanies, mappings =>
                {
                    mappings.For<_CoreLVL>(binding => binding
                    .ItemDataBound((item, core) =>
                    {
                        item.Text = core.CoreNameDisplayText;
                        item.Value = core.ID.ToString();
                    })

                    .Children(maturity => maturity._CRMs));

                    mappings.For<_CRM>(binding => binding
                  .ItemDataBound((item, crm) =>
                  {
                      item.Text = crm.DisplayName;
                      item.Value = crm.ID.ToString();
                  }));
                })

) 
    }
    }
    
</div>
<script>
    //var count=0
    //公司选择
    function onIndexSelect(e) {
        var nv = $('#memberCompanies').data('tTreeView');
        if ($(e.item).parents(".t-item").length == 0) {
            $.post('GetCoreCoverage', { projectid: $("#projectid").data("tDropDownList").value(), coreid: nv.getItemValue(e.item) }, function (result) {
                $('#crmdetailscontainer').html(result);
            });
            return;
        }
        if ($(e.item).parents(".t-item").length != 2)
            return;
       
        var clickedvalue = nv.getItemValue(e.item);
        
        if (crmid != clickedvalue)
            gleadid = "";
        crmid = clickedvalue;
        clickpublic = false;
        $(".t-state-selected").removeClass('t-state-selected');
        
        if (gleadid == "" || gleadid == undefined) {
            $.post('_SelectedCRMNode', { crmid: crmid }, function (result) {
                $('#crmdetailscontainer').html(result);
                jQuery(".PickUp").hide();
            });
        }
        else {
            $.post('GetCRMByCrmIDLeadID', { crmid: crmid, leadid: gleadid }, function (result) {
                $('#crmdetailscontainer').html(result);
                var leaddiv = $('#lead' + gleadid);
//                leaddiv.removeClass('center_2');
//                leaddiv.addClass('center_1');
                jQuery(".PickUp").hide();
            });
        }
        

    }
    //公海公司选择
    function onIndexSelectPublic(e) {
        if ($(e.item).parents(".t-item").length == 0) {
            $('#crmdetailscontainer').html('');
            return;
        }
        if ($(e.item).parents(".t-item").length != 1)
            return;
        var nv = $('#memberCompanies').data('tTreeView');
        var clickedvalue = nv.getItemValue(e.item);

        if (crmid != clickedvalue)
            gleadid = "";
        crmid = clickedvalue;
        clickpublic = true;
        $(".t-state-selected").removeClass('t-state-selected');
        if (gleadid == "" || gleadid == undefined) {
            $.post('_SelectedCRMNode', { crmid: crmid }, function (result) {
                $('#crmdetailscontainer').html(result);
                hidebtn();
                jQuery(".UnPickUp").hide();
            });
        }
        else {
            $.post('GetCRMByCrmIDLeadID', { crmid: crmid, leadid: gleadid }, function (result) {
                $('#crmdetailscontainer').html(result);
                var leaddiv = $('#lead' + gleadid);
//                leaddiv.removeClass('center_2');
//                leaddiv.addClass('center_1');
                hidebtn();
                jQuery(".UnPickUp").hide();
            });
        }
        

    }
    function OnmemberLoad() {
        var treeView = $("#memberCompanies").data("tTreeView");
        var item = $("> ul > li", treeView.element);
        treeView.expand(item);
    }
    
    function hidebtn() {
        jQuery(".hide").hide();
        jQuery(".click").removeAttr("onclick");
        $('#ProgressIDdiv').hide();
        
    }
    
</script>