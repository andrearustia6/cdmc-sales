@using Entity
@using Sales.Model
@model _CRM
<style>
    .fieldblock
    {
    }
    .fieldname div
    {
        padding: 2px;
        min-width: 100px;
        background-color: #FFDEAD;
        border-bottom-color: #FF8C00;
        border: 1px solid #CCC;
        display: inline-block;
        margin-left: 8px;
        margin-bottom: 8px;
    }
    .fieldname div font
    {
        font-size: 12px;
        color: Green;
    }
    
    .selections span
    {
    }
    .fieldError
    {
        border: 1px solid red !important;
    }
</style>
<div class="memberCompanies">
<div class="quan">
<div class="quan_1">
<a  class="PickUp" href="#" onclick="onPickUp()">领用</a>


	<div class="quan_2">6.12<p><img src="../images/quan-01.jpg" width="19" height="20" alt="yuan" /></p></div>
    <div class="quan_3">-2</div>
    <div class="quan_2">6.12<p><img src="../images/quan-03.jpg" width="19" height="20" alt="yuan" /></p></div>
    <div class="quan_3">-2</div>
	<div class="quan_2">6.12<p><img src="../images/quan-04.jpg" width="19" height="20" alt="yuan" /></p></div>
    <div class="quan_3">-2</div>
    <div class="quan_2">6.12<p><img src="../images/quan-05.jpg" width="19" height="20" alt="yuan" /></p></div>
    @{ 
    if (Utl.Employee.CurrentRole.Level == ManagerRequired.LVL)
    {
        <div >是否核心：
        @(Html.DropDownListFor(model => model.CoreLVLID, Utl.SelectHelper.CoreLVLSelectList(null), "请选择", new { }))
        </div>
    }
}

</div>
</div>
<div class="quan_4">
	<div class="left">
    	<div class="left_1"><p>@Model.CompanyName</p>
        @{if(Model.Contact!=null)
          {
              <p>T:+ @Model.Contact</p>
          }
        }
        @{if (Model.Fax != null)
          {
              <p>F:+ @Model.Fax</p>
          }
        }
      


</div>
        <div class="left_2">
        @if (Model.CoreCompany)
        {
        <a href="#"><img src="../images/quan-06.jpg" width="13" height="12" alt="xing" /></a>
        }
        <a Class="hide" href="#"><img src="../images/pen1919.png" alt="bianji" onclick="onCompanyEdit(@(Model.CompanyID))"/></a>
        <a Class="hide" href="#"  onclick="onLeadAdd(@(Model.CompanyID))"><img src="../images/user.png" alt="新增Leader" width="19" height="19" /></a></div>
        <div class="left_3">
        	<div class="left_4">决策人状态统计</div>
            <div class="left_5">
                <img src="../images/quan-01.png" width="15" height="15" alt="yuan" title="没联系" />@Model.NoCallCount
                <img src="../images/quan-09.png" width="15" height="15" alt="yuan" title="Not Piteched" />@Model.BlowedCount
                <img src="../images/quan-10.png" width="15" height="15" alt="yuan" title="Pitched和Full Pitched和Call Backed" />@Model.TotalPitchCount
                <img src="../images/55.png" width="15" height="15" alt="yuan" title="Qualified Decision和Waiting for Approval" />@Model.QualifiedWaitForCount
                <img src="../images/quan-08.png" width="15" height="15" alt="yuan" title="Closed" />@Model.CloseDealCount
            </div>
            <div class="left_6">
            	<ul>
                	<li>
                    	<h2>行业细分</h2>
                        @if (!string.IsNullOrWhiteSpace(Model.CategoryString))
                        {
                            @Model.CategoryString
                        }
                        <a href="#" onclick="GetCategories(@(Model.ID))"><img src="../images/quan-13.jpg" width="20" height="18" alt="wenhao" /></a>
                    </li>
                    <li>
                    	<h2>公司简介</h2>
                        @if (!string.IsNullOrWhiteSpace(Model.Description))
                        {
                            if (Model.Description.Length > 50)
                            {
                                @Model.Description.Substring(0, 50)
                                 @Model.Description.Substring(0, 50)
                                <p><a href="#"  onclick="onDescription(@(Model.ID))">更多>></a></p>
                            }
                            else
                            {
                                @Model.Description
                            }

                        }
                    </li>
                    <li>
                    	<h2>竞争对手</h2>
                        @if (!string.IsNullOrWhiteSpace(Model.Competitor))
                        {

                            if (Model.Competitor.Length > 20)
                            {
                            @Model.Competitor.Substring(0, 20) 

                                <p><a href="#" onclick="onCompetitor(@(Model.ID))">更多>></a></p>
                            }
                            else
                            {
                                @Model.Competitor
                            }

                        }
                    </li>
                    <li>
                    	<h2>Pitch Point</h2>
                        @if (!string.IsNullOrWhiteSpace(Model.PitchPoint))
                        {

                            if (Model.PitchPoint.Length > 50)
                            {
                           @Model.PitchPoint.Substring(0, 50)

                                <p><a href="#"  onclick="onPitchPoint(@(Model.ID))">更多>></a></p>

                            }
                            else
                            {
                                 @Model.PitchPoint
                            }

                        }
                         
                    </li>
                </ul>
            </div>
        </div>

    	<div class="dierye_1">
            <div style="float: left;width: 70%;">
                点评
            </div>
            <div style="float: left;width: 20%;">
                <a Class="hide" href="#" onclick="GetAddComment()"><img src="../images/quan-14.jpg" width="29" height="29" alt="jia"></a>
            </div>
        </div>
        
    	<div class="dierye_3">
         @if (Model._Comments != null)
         {
             var i = 1;
             foreach (var comment in Model._Comments)
             {
        	<div class="dierye_3_@(i)">
            	<dl>
                	<dt><p>@comment.Content</p>
                    <p>@comment.CommentDate.ToLongDateString() @comment.CommentDate.ToShortTimeString() By @comment.Submitter</p>
                    </dt>
                </dl>
            </div>
                                                                                                      i++;
                                                                                                      if (i > 2)
                                                                                                      {
                                                                                                          i = 1;
                                                                                                      }
             }
         }
            
        </div>
    </div>
    
    <div class="center">
   
     @if (Model._Leads != null)
     {
         var index = 1;
         foreach (var lead in Model._Leads)
         {
             <a href="#"  onclick="onLeadSelect(@(lead.ID))">
            <div  class="center_2" id="lead@(lead.ID)">
            <img Class="hide"  src="../images/dianhua.png" alt="新增通话" onclick="onCallAdd(@(lead.ID))" style=" display: inline;float: right;" />
            <img Class="hide" src="../images/bianji.png" alt="编辑" onclick="onLeadEdit(@(lead.ID))" style=" display: inline;float: right;" />
            
                <dl>
                    <dt>
                        @{
                                                                                   var calls = @Model._LeadCalls.Where(c => c.LeadID == lead.ID).OrderByDescending(c => c.CallDate).FirstOrDefault();
                                                                                   if (calls == null)
                                                                                   {
                                <img src="../images/quan-01.png" width="15" height="15" alt="yuan" title="没联系" />
                                                                                   }
                                                                                   else
                                                                                   {
                                                                                       if (calls.LeadCallTypeID == 2 || calls.LeadCallTypeID == 3)
                                                                                       {
                                    <img src="../images/quan-09.png" width="15" height="15" alt="yuan" title="Blowed和Not Piteched" />}
                                                                                       else if (calls.LeadCallTypeID == 4 || calls.LeadCallTypeID == 5 || calls.LeadCallTypeID == 6)
                                                                                       {
                                    <img src="../images/quan-10.png" width="15" height="15" alt="yuan" title="Pitched和Full Pitched和Call Backed" />}
                                                                                       else if (calls.LeadCallTypeID == 7 || calls.LeadCallTypeID == 8)
                                                                                       {
                                    <img src="../images/55.png" width="15" height="15" alt="yuan" title="Qualified Decision和Waiting for Approval" />}
                                                                                       else if (calls.LeadCallTypeID == 9)
                                                                                       {
                                    <img src="../images/quan-08.png" width="15" height="15" alt="yuan" title="Closed" />}
                                                                                   }
                         }
                        
                        @*@if (index == 1)
                        {
                            <img src="../images/00.png" width="14" height="14" alt="tu" />
                        }
                        else
                        {
                            <img src="../images/22.png" width="14" height="14" alt="tu" />
                        }*@
                    </dt>
                    <dd>
                        <p>@lead.Name</p>
                        
                        @{if (@lead.Title != null)
                          {
                        <p>@lead.Title</p>
                          }
                            }
                      </dd>
                      </dl>
                        @{if (@lead.Contact != null)
                          {
                              <dl>
                              <dt><img src="../images/shouji.png" width="15" height="15" alt="yuan"  /></dt>
                            <dd><p>@lead.Contact</p></dd>
                            </dl>
                        
                          }
                            }
                        @{if (@lead.TelePhone != null)
                          {
                              <dl>
                              <dt><img src="../images/zuoji.png" width="15" height="15" alt="yuan" /></dt>
                            <dd><p>@lead.TelePhone</p></dd>
                            </dl>
                          }
                            }
                         @{if (@lead.Email != null)
                           {
                               <dl>
                              <dt><img src="../images/youjian.png" width="15" height="15" alt="yuan"  /></dt>
                            <dd><p>@lead.Email</p></dd>
                            </dl>
                           }
                            }
                     
                 
                 
            </div>
         </a>
                           index++;
                           if (index > 2)
                           {
                               index = 1;
                           }
         }
     }
    	
</div>
<div class="right">

@if (Model._LeadCalls != null)
{
    var index = 1;
    var leadcalls = @Model._LeadCalls;
    if (ViewBag.leadid > 0)
    {
        leadcalls = leadcalls.Where(c => c.LeadID == ViewBag.leadid);
    }
    foreach (var call in leadcalls)
    {
            <div  class="right_@(index)">
               <h2>@call.LeadName  | @call.LeadTitle </h2>
            <p><span>@call.CallType</span></p>
            <p><span>@call.CallResult</span></p>
            <p>@call.CallDate.ToLongDateString() @call.CallDate.ToShortTimeString()</p>
            <p>By @call.Creator</p>
            </div>
        index++;
        if (index > 2)
        {
            index = 1;
        }
    }
}
    	
  </div>
</div>
</div>

<script>
    $(function () {
        $("#CoreLVLID").change(function () {
            if ($("#CoreLVLID").val() == '') {
                alert('请选择是否核心公司');
                return;
            }
            $.post('ChangeCore', { crmid: crmid, corelvlid: $("#CoreLVLID").val() }, function (result) {
                if (result.companyRelationshipId != null) {
                    alert('修改成功');
                    crmid = result.companyRelationshipId;
                    var currentProjectId = $('#projectid').val();
                    var corelvlid = result.corelvlid;
                    var processid = result.processid;
                    $.post('_RefreshCrmTree', { projectid: currentProjectId }, function (result) {
                        $('#mainnavigationcontainer').html(result);
                        if (crmid > 0) {
                            if (clickpublic)
                                onPublicCompanyChanging(crmid, corelvlid);
                            else
                                onCompanyChanging(crmid, processid, corelvlid);
                        }
                    });
                }
                else
                    alert('修改失败');
            });
        })
    })
</script>