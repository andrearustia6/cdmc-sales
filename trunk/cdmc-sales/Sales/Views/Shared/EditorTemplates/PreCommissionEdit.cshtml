@model Sales.Model._PreCommission
@using Utl
<style type="text/css">
   
    
    /* in-form editing */
    .t-edit-form-container
    {
         width: 1100px;
        height:400px;
        margin: 1em;
        text-align: right;
    }
   td
   {
       text-align:left;
   }
</style>
<script>

    $("#TargetNameEN option[text='" + TargetNameEN + "']").attr("selected", true);
       
</script>
<script type="text/javascript">

    function OnChange(e) {
        var StartDate = strTodate($("#StartDate").val());
        var DateB = new Date(StartDate.getFullYear(), StartDate.getMonth() + 1, 0); //当月的最后一天
        yy = DateB.getFullYear();
        mm = DateB.getMonth() + 1;
        dd = DateB.getDate();
        datestr = yy + '-' + mm + '-' + dd;
        $("#EndDate").val(datestr);
        var sale = $("#TargetNameEN").find("option:selected").val();
        if (sale == "") {
           return;
        }
        var month = StartDate.getMonth() + 1;
        $.ajax({
            url: "/Finance/GetIncome",
            type: "post",
            dataType: "json",
            data: { month: month, sale: sale },
            error: function (a, b, c) {
                alert("获取数据失败，请重试。");
            },
            success: function (result) {
                setvalue(result);
            }
        });
    }
    function OnRateChange(e) {
        calc();
    }
    function OnTaxChange(e) {
        calc();
    }
    function OnBonusChange(e) {
        calc();
    }
    function OnReturnIncomeChange(e) {

        calc();
    }

    function calc() {
        $("#DelegateLessCommission").val($("#DelegateLessIncome").val() * $("#DelegateLessRate").val() / 100);
        $("#DelegateMoreCommission").val($("#DelegateMoreIncome").val() * $("#DelegateMoreRate").val() / 100);
        $("#SponsorCommission").val($("#SponsorIncome").val() * $("#SponsorRate").val() / 100);

        var DelegateLessCommission = $("#DelegateLessIncome").val() * $("#DelegateLessRate").val() / 100;
        var DelegateMoreCommission = $("#DelegateMoreIncome").val() * $("#DelegateMoreRate").val() / 100;
        var SponsorCommission = $("#SponsorIncome").val() * $("#SponsorRate").val() / 100;

        $("#Commission").val(DelegateLessCommission + DelegateMoreCommission + SponsorCommission);
        var commission = $("#Commission").val();
        var bonus = $("#Bonus").val();
        var tax = $("#Tax").val();
        var returnincome = $("#ReturnIncome").val();

        $("#ActualCommission").val(commission - bonus - tax - returnincome);
        $("#TotalCommission").val(commission - bonus - tax);
    }
    function strTodate(strr) {
        strr1 = strr.split(' ');
        datestr = strr1[0];
        strr2 = datestr.split('-');
        date1 = new Date(strr2[0], strr2[1] - 1, strr2[2]);
        return date1;
    }
   function setvalue(result) {
        if (result.TargetNameEN != "") {
            $("#ProjectNames").val(result.ProjectNames);
            $("#TargetNameCN").val(result.TargetNameCN);
            $("#InOut").val(result.InOut);

            $("#DelegateLessIncomeStr").val(result.DelegateLessIncomeStr);
            $("#DelegateMoreIncomeStr").val(result.DelegateMoreIncomeStr);
            $("#SponsorIncomeStr").val(result.SponsorIncomeStr);
            $("#IncomeStr").val(result.IncomeStr);

            $("#DelegateLessIncome").val(result.DelegateLessIncome == null ? 0 : result.DelegateLessIncome);
            $("#DelegateMoreCount").val(result.DelegateMoreCount == null ? 0 : result.DelegateMoreCount);
            $("#DelegateMoreIncome").val(result.DelegateMoreIncome == null ? 0 : result.DelegateMoreIncome);
            $("#SponsorIncome").val(result.SponsorIncome == null ? 0 : result.SponsorIncome);
            $("#Income").val(result.Income);

            $("#DelegateMoreRate").val(15);
            $("#SponsorRate").val(5);
            $("#DelegateLessCommission").val(result.DelegateLessIncome == null ? 0 : result.DelegateLessIncome);
            $("#DelegateMoreCommission").val(result.DelegateMoreIncome == null ? 0 : result.DelegateMoreIncome * 0.15);
            $("#SponsorCommission").val(result.SponsorIncome == null ? 0 : result.SponsorIncome * 0.05);

            var DelegateLessCommission = result.DelegateLessIncome == null ? 0 : result.DelegateLessIncome;
            var DelegateMoreCommission = result.DelegateMoreIncome == null ? 0 : result.DelegateMoreIncome * 0.15;
            var SponsorCommission = result.SponsorIncome == null ? 0 : result.SponsorIncome * 0.05;
            $("#Commission").val(DelegateLessCommission + DelegateMoreCommission + SponsorCommission);
            $("#TotalCommission").val($("#Commission").val());
            $("#ActualCommission").val($("#Commission").val());
        }
        else
            alert("没有获取到入账数据。");
    }
</script>

<div style=" padding-bottom:10px;width:100%"> 
@Html.HiddenFor(model => model.ID)
@Html.HiddenFor(model => model.DelegateLessIncome)
@Html.HiddenFor(model => model.DelegateMoreIncome)
@Html.HiddenFor(model => model.SponsorIncome)
@Html.HiddenFor(model => model.Income)
<legend  style="text-align:left">提成预发表</legend>
   <table style="width:100%" >
    <tr>
        <td  style="width:20%">
            开始时间
        </td>
        <td  style="width:5%">
            @Html.Telerik().DatePickerFor(model => model.StartDate).ClientEvents(e => e.OnChange("OnChange"))
            @Html.ValidationMessageFor(model => model.StartDate)
        </td>
        <td  style="width:20%">
            结束时间
        </td>
        <td  style="width:5%">
            @Html.Telerik().DatePickerFor(model => model.EndDate)
            @Html.ValidationMessageFor(model => model.EndDate)
        </td>
        <td  style="width:20%">
            英文名
        </td>
        <td  style="width:5%">
            @Html.DropDownListFor(model => model.TargetNameEN, BLL.Finance_Logical._PreCommissionBLL.GetSalesDDL(DateTime.Now.Month), "请选择")
            @Html.ValidationMessageFor(model => model.TargetNameEN)
        </td>
        <td  style="width:20%">
            中文名
        </td>
        <td  style="width:5%">
             @Html.TextBoxFor(model => model.TargetNameCN, new { READONLY = "readonly", style = "border:none;" })
        </td>
    </tr>
    <tr>
        <td>
            @Html.LabelFor(model => model.ProjectNames)
        </td>
        <td colspan="3">
            @Html.TextBoxFor(model => model.ProjectNames, new { READONLY = "readonly", style = "border:none;width:100%" })
        </td>
        <td>
            @Html.LabelFor(model => model.InOut)
        </td>
        <td colspan="3">
            @Html.TextBoxFor(model => model.InOut, new { READONLY = "readonly", style = "border:none;" })
        </td>
        
    </tr>
    <tr>
        <td >
            @Html.LabelFor(model => model.DelegateLessIncome)
        </td>
        <td >
            ￥@Html.TextBoxFor(model => model.DelegateLessIncomeStr, new { READONLY = "readonly", style = "border:none;width:50%" })
        </td>
        <td >
         @Html.LabelFor(model => model.DelegateLessRate)
        </td>
        <td >
        @Html.TextBoxFor(model => model.DelegateLessRate)
        </td>
        <td colspan="2">
        </td>
        <td  >
            @Html.LabelFor(model => model.DelegateLessCommission)
        </td>
        <td  >
            ￥@Html.TextBoxFor(model => model.DelegateLessCommission, new { READONLY = "readonly", style = "border:none;width:50%" }) 
        </td>
        
    </tr>
    <tr>
       
        <td >
        @Html.LabelFor(model => model.DelegateMoreIncome)
        </td>
        <td>
        ￥@Html.TextBoxFor(model => model.DelegateMoreIncomeStr, new { READONLY = "readonly", style = "border:none;width:50%" })
        </td>
        <td >
            @Html.LabelFor(model => model.DelegateMoreRate)
        </td>
        <td>
            @Html.TextBoxFor(model => model.DelegateMoreRate)
        </td>
        <td>
            大于3000人数
        </td>
        <td>
            @Html.TextBoxFor(model => model.DelegateMoreCount, new { READONLY = "readonly", style = "border:none;" })
        </td>
        <td >
            @Html.LabelFor(model => model.DelegateMoreCommission)
        </td>
        <td>
            ￥@Html.TextBoxFor(model => model.DelegateMoreCommission, new { READONLY = "readonly", style = "border:none;width:50%" }) 
        </td>
         
        
    </tr>
    <tr>
        <td >
            @Html.LabelFor(model => model.SponsorIncome)
        </td>
        <td >
        
            ￥@Html.TextBoxFor(model => model.SponsorIncomeStr, new { READONLY = "readonly", style = "border:none;width:50%" })
        </td>
        <td >
         @Html.LabelFor(model => model.SponsorRate)
        </td>
        <td >
        @Html.TextBoxFor(model => model.SponsorRate)
        </td>
        <td   colspan="2">
        </td>
        <td   >
            @Html.LabelFor(model => model.SponsorCommission)
        </td>
        <td  >
           ￥@Html.TextBoxFor(model => model.SponsorCommission, new { READONLY = "readonly", style = "border:none;width:50%" }) 
        </td>
        
    </tr>
    <tr>
        <td >
         @Html.LabelFor(model => model.Income)
        </td>
        <td colspan="5" >
        ￥@Html.TextBoxFor(model => model.IncomeStr, new { READONLY = "readonly", style = "border:none;width:50%" })
        </td>
        <td>
            @Html.LabelFor(model => model.Commission)
        </td>
        <td >
        ￥@Html.TextBoxFor(model => model.Commission, new { READONLY = "readonly", style = "border:none;width:50%" }) 
        </td>
        
    </tr>
    <tr>
        <td>
         @Html.LabelFor(model => model.Tax)
        </td>
        <td>
        @Html.Telerik().CurrencyTextBoxFor(model => model.Tax).ClientEvents(e => e.OnChange("OnTaxChange"))
        </td>
        <td>
            @Html.LabelFor(model => model.Bonus)
        </td>
        <td>
            @Html.Telerik().CurrencyTextBoxFor(model => model.Bonus).ClientEvents(e => e.OnChange("OnBonusChange"))
        </td>
        
        <td >
        @Html.LabelFor(model => model.TotalCommission)
        </td>
        <td>
        ￥@Html.TextBoxFor(model => model.TotalCommission, new { READONLY = "readonly", style = "border:none;width:50%" })
        </td>
        <td >
         @Html.LabelFor(model => model.ActualCommission)
        </td>
        <td>
        ￥@Html.TextBoxFor(model => model.ActualCommission, new { READONLY = "readonly", style = "border:none;width:50%" })
        </td>
    </tr>
    <tr>
    <td colspan="8" style="color:Red">
    每月提成预发总额 = sponsor出单总额* 提成率(5%)+delegate人均三千以下出单总额*提成率(%) +(delegate人均3000以上出单总额-3000*人数)*大于3000提成率(15%)
    </td>
    </tr>
</table>
<table style="width:100%">
 <tr>
        
        <td>
         @Html.LabelFor(model => model.ReturnIncome)
        </td>
        <td>
        @Html.Telerik().CurrencyTextBoxFor(model => model.ReturnIncome).ClientEvents(e => e.OnChange("OnReturnIncomeChange"))
        </td>
        <td>
            @Html.LabelFor(model => model.ReturnReason)
        </td>
        <td colspan="5">
            @Html.TextAreaFor(model => model.ReturnReason)
        </td>
        
    </tr>
    <tr>
    <td colspan="8" style="color:Red">
    提成发放后如发生退款，请填写冲销金额
    </td>
    </tr>
</table>
</div>
<script type="text/javascript">

    //页面加载后设置币种的默认值
    $(function () {
        $("#TargetNameEN").change(function () {
            var sale = $("#TargetNameEN").find("option:selected").val();
            if ($("#StartDate").val() == "") {
                alert("请选择开始时间");
                $("#TargetNameEN option[text='请选择']").attr("selected", true);
                return;
            }
            var StartDate = strTodate($("#StartDate").val());
            var month = StartDate.getMonth() + 1;
            $.ajax({
                url: "/Finance/GetIncome",
                type: "post",
                dataType: "json",
                data: { month: month, sale: sale },
                error: function (a, b, c) {
                    alert("获取数据失败，请重试。");
                },
                success: function (result) {
                    setvalue(result);
                }
            });
        });
        $("#DelegateLessRate").change(function () {
            calc();
        });
        $("#DelegateMoreRate").change(function () {
            calc();
        });
        $("#SponsorRate").change(function () {
            calc();
        });
    });
    

//    var datepicker = $('#cEndDate').data('tDatePicker');
//    alert(datepicker);
//    datepicker.val(new Date('1/1/2012'));
</script>
